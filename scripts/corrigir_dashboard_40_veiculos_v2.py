#!/usr/bin/env python3
"""
Script para corrigir ve√≠culos do dashboard
Atualizado para a estrutura correta dos dados JSON
"""

import json
import os
import shutil
from datetime import datetime


def fazer_backup():
    """Faz backup dos arquivos que ser√£o alterados"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_dir = f"dados/json/old/backup_correcao_{timestamp}"
    os.makedirs(backup_dir, exist_ok=True)

    arquivos_backup = [
        'static/js/dash.js',
        'dados/json/estatisticas_atualizadas.json',
        'README.md'
    ]

    print("üõ°Ô∏è Fazendo backup dos arquivos...")
    for arquivo in arquivos_backup:
        if os.path.exists(arquivo):
            shutil.copy2(arquivo, backup_dir)
            print(f"‚úÖ Backup: {arquivo}")

    print(f"üõ°Ô∏è Backup completo em: {backup_dir}")
    return backup_dir


def calcular_veiculos_corretos():
    """Calcula dados corretos baseado nos arquivos JSON com estrutura real"""
    try:
        # Carregar dados de escolas (estrutura real)
        with open('dados/json/dados_escolas_atualizados.json', 'r', encoding='utf-8') as f:
            escolas = json.load(f)

        # Verificar a estrutura real dos dados
        print(f"üìä Total de escolas: {len(escolas)}")
        if escolas:
            print(f"üîç Campos dispon√≠veis: {list(escolas[0].keys())}")

        # Contar por tipo usando a estrutura real
        tipos = {}
        diretorias_com_escolas = set()

        for escola in escolas:
            # Usar 'type' que √© o campo real
            tipo = escola.get('type', 'Desconhecido')
            if tipo not in tipos:
                tipos[tipo] = 0
            tipos[tipo] += 1

            # Usar 'diretoria' que √© o campo real
            diretorias_com_escolas.add(escola.get('diretoria', ''))

        print(f"üìù Tipos encontrados: {tipos}")
        print(f"üìç Diretorias com escolas: {len(diretorias_com_escolas)}")

        # Carregar dados de ve√≠culos
        with open('dados/json/dados_veiculos_diretorias.json', 'r', encoding='utf-8') as f:
            veiculos_data = json.load(f)

        # Contar ve√≠culos apenas das diretorias que atendem escolas
        total_veiculos = 0
        diretorias_atendidas = 0
        detalhamento = {}

        print("\nüìã Detalhamento por diretoria:")
        for diretoria_nome in sorted(diretorias_com_escolas):
            if not diretoria_nome:  # Pular valores vazios
                continue

            # Tentar diferentes varia√ß√µes do nome
            nome_upper = diretoria_nome.upper()
            encontrada = False

            for key in veiculos_data['diretorias'].keys():
                if key.upper() == nome_upper:
                    veiculos_dir = veiculos_data['diretorias'][key]['total']
                    total_veiculos += veiculos_dir
                    diretorias_atendidas += 1
                    detalhamento[diretoria_nome] = veiculos_dir
                    print(f"   ‚úÖ {diretoria_nome}: {veiculos_dir} ve√≠culos")
                    encontrada = True
                    break

            if not encontrada:
                print(f"   ‚ùå {diretoria_nome}: N√ÉO ENCONTRADA")

        print(f"\nüéØ RESULTADO:")
        print(f"   ‚Ä¢ Total de escolas: {len(escolas)}")
        print(f"   ‚Ä¢ Ind√≠genas: {tipos.get('indigena', 0)}")
        print(f"   ‚Ä¢ Quilombolas: {tipos.get('quilombola', 0)}")
        print(f"   ‚Ä¢ Diretorias atendidas: {diretorias_atendidas}")
        print(f"   ‚Ä¢ TOTAL DE VE√çCULOS: {total_veiculos}")

        return {
            'total_escolas': len(escolas),
            'total_veiculos': total_veiculos,
            'total_diretorias': diretorias_atendidas,
            'tipos_escola': tipos,
            'diretorias_com_escolas': list(diretorias_com_escolas),
            'detalhamento_veiculos': detalhamento
        }

    except Exception as e:
        print(f"‚ùå Erro ao calcular ve√≠culos: {e}")
        import traceback
        traceback.print_exc()
        return None


def corrigir_dashboard_js(total_veiculos):
    """Corrige o arquivo dash.js para mostrar o n√∫mero correto de ve√≠culos"""
    print(
        f"\nüîß Corrigindo dashboard para mostrar {total_veiculos} ve√≠culos...")

    try:
        with open('static/js/dash.js', 'r', encoding='utf-8') as f:
            conteudo = f.read()

        # Buscar padr√µes que definem o total de ve√≠culos
        import re

        # Padr√£o para encontrar linhas como: totalVehicles: 6
        padrao_total = re.compile(r'totalVehicles:\s*(\d+)', re.IGNORECASE)
        matches = padrao_total.findall(conteudo)

        if matches:
            for match in matches:
                valor_antigo = match
                linha_antiga = f"totalVehicles: {valor_antigo}"
                linha_nova = f"totalVehicles: {total_veiculos} // CORRIGIDO de {valor_antigo}"
                conteudo = conteudo.replace(linha_antiga, linha_nova)
                print(
                    f"‚úÖ Corrigido: {linha_antiga} ‚Üí totalVehicles: {total_veiculos}")

        # Tamb√©m buscar outros padr√µes poss√≠veis
        outros_padroes = [
            (r'vehicles:\s*(\d+)', f'vehicles: {total_veiculos}'),
            (r'totalVehicles\s*=\s*(\d+)',
             f'totalVehicles = {total_veiculos}'),
            (r'veiculos:\s*(\d+)', f'veiculos: {total_veiculos}')
        ]

        for padrao, substituicao in outros_padroes:
            conteudo = re.sub(padrao, substituicao,
                              conteudo, flags=re.IGNORECASE)

        # Salvar arquivo corrigido
        with open('static/js/dash.js', 'w', encoding='utf-8') as f:
            f.write(conteudo)

        print(f"‚úÖ Dashboard JavaScript atualizado")
        return True

    except Exception as e:
        print(f"‚ùå Erro ao corrigir dashboard: {e}")
        return False


def criar_estatisticas_atualizadas(dados):
    """Cria arquivo de estat√≠sticas com dados corretos"""
    print("\nüìà Criando estat√≠sticas atualizadas...")

    try:
        estatisticas = {
            "ultima_atualizacao": datetime.now().isoformat(),
            "resumo": {
                "total_escolas": dados['total_escolas'],
                "total_veiculos_diretorias_relevantes": dados['total_veiculos'],
                "total_diretorias_atendendo_escolas": dados['total_diretorias'],
                "tipos_escola": dados['tipos_escola']
            },
            "detalhamento": dados['detalhamento_veiculos'],
            "observacoes": [
                f"Dados corrigidos automaticamente em {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
                f"Dashboard atualizado para mostrar {dados['total_veiculos']} ve√≠culos",
                "Contagem considera apenas diretorias que atendem escolas ind√≠genas/quilombolas"
            ]
        }

        with open('dados/json/estatisticas_atualizadas.json', 'w', encoding='utf-8') as f:
            json.dump(estatisticas, f, indent=2, ensure_ascii=False)

        print("‚úÖ Estat√≠sticas atualizadas criadas")
        return True

    except Exception as e:
        print(f"‚ùå Erro ao criar estat√≠sticas: {e}")
        return False


def atualizar_readme(dados):
    """Atualiza README.md com dados corretos"""
    print("\nüìù Atualizando README...")

    try:
        # Ler README atual
        with open('README.md', 'r', encoding='utf-8') as f:
            readme = f.read()

        # Substituir valores incorretos
        substituicoes = [
            ('6 ve√≠culos', f"{dados['total_veiculos']} ve√≠culos"),
            ('6 Ve√≠culos', f"{dados['total_veiculos']} Ve√≠culos"),
            ('total: 6', f"total: {dados['total_veiculos']}"),
        ]

        for antigo, novo in substituicoes:
            if antigo in readme:
                readme = readme.replace(antigo, novo)
                print(f"‚úÖ README: {antigo} ‚Üí {novo}")

        # Salvar README atualizado
        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(readme)

        print("‚úÖ README atualizado")
        return True

    except Exception as e:
        print(f"‚ùå Erro ao atualizar README: {e}")
        return False


def validar_correcoes():
    """Valida se as corre√ß√µes foram aplicadas corretamente"""
    print("\nüîç Validando corre√ß√µes...")

    validacoes = []

    # Verificar se o dashboard foi corrigido
    try:
        with open('static/js/dash.js', 'r', encoding='utf-8') as f:
            js_content = f.read()

        if 'totalVehicles: 40' in js_content or 'totalVehicles = 40' in js_content:
            validacoes.append("‚úÖ Dashboard JavaScript corrigido")
        else:
            validacoes.append("‚ùå Dashboard JavaScript n√£o foi corrigido")
    except:
        validacoes.append("‚ùå Erro ao verificar dashboard")

    # Verificar estat√≠sticas
    try:
        with open('dados/json/estatisticas_atualizadas.json', 'r', encoding='utf-8') as f:
            stats = json.load(f)

        if stats['resumo']['total_veiculos_diretorias_relevantes'] >= 40:
            validacoes.append("‚úÖ Estat√≠sticas atualizadas")
        else:
            validacoes.append("‚ùå Estat√≠sticas n√£o atualizadas")
    except:
        validacoes.append("‚ùå Erro ao verificar estat√≠sticas")

    # Mostrar resultados
    for validacao in validacoes:
        print(f"   {validacao}")

    return all('‚úÖ' in v for v in validacoes)


def main():
    """Fun√ß√£o principal de corre√ß√£o"""
    print("üöÄ INICIANDO CORRE√á√ÉO AUTOM√ÅTICA COMPLETA")
    print("=" * 50)

    try:
        # 1. Fazer backup
        backup_dir = fazer_backup()

        # 2. Calcular dados corretos
        print("\nüìä Calculando ve√≠culos corretos...")
        dados = calcular_veiculos_corretos()

        if not dados:
            print("‚ùå Falha ao calcular dados")
            return False

        total_veiculos = dados['total_veiculos']

        # 3. Corrigir dashboard
        if not corrigir_dashboard_js(total_veiculos):
            print("‚ùå Falha ao corrigir dashboard")
            return False

        # 4. Criar estat√≠sticas
        if not criar_estatisticas_atualizadas(dados):
            print("‚ùå Falha ao criar estat√≠sticas")
            return False

        # 5. Atualizar README
        if not atualizar_readme(dados):
            print("‚ùå Falha ao atualizar README")
            return False

        # 6. Validar corre√ß√µes
        if validar_correcoes():
            print("\nüéâ CORRE√á√ÉO CONCLU√çDA COM SUCESSO!")
            print(f"üéØ Dashboard agora mostra {total_veiculos} ve√≠culos")
            print(f"üìÅ Backup salvo em: {backup_dir}")
        else:
            print("\n‚ö†Ô∏è CORRE√á√ÉO PARCIAL - verificar valida√ß√µes")

        return True

    except Exception as e:
        print(f"\n‚ùå ERRO CR√çTICO: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    main()
